name: (APK)

on:
  push:
    branches:
      - main # Trigger on pushes to the main branch
  workflow_dispatch: # Allows manual trigger from the GitHub Actions tab

jobs:
  build_android:
    runs-on: ubuntu-latest
    
    # Define environment variables for the build process
    env:
      FLUTTER_VERSION: '3.22.x' # Use the version required by your project
      JAVA_VERSION: '21.0.x'    # Matches the JVM target 21 you configured

    steps:
      - name: 1. ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4

      # --- SETUP ---

      - name: 2. ‚òï Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: 3. üíô Set up Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: 4. üì¶ Get Flutter Dependencies
        run: flutter pub get

      # --- SIGNING FIXES ---
      
      # 5. GENERATE DEBUG KEY: Fixes the 'debug.keystore not found' validation error.
      # This creates the dummy debug key in the expected location.
      - name: 5. Generate Dummy Debug Keystore
        run: |
          mkdir -p android/app
          keytool -genkey -v -keystore android/app/debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
        shell: bash

      # 6. INJECT RELEASE KEY: Decodes the Base64 secret and places the JKS file.
      # This is ESSENTIAL for the release build.
      - name: 6. Inject Release Keystore from Secrets
        # Check if the secret exists before trying to decode
        if: ${{ secrets.KEY_STORE_FILE_BASE64 != '' }}
        run: |
          # Decode the Base64 string and save it as release-key.jks
          echo "${{ secrets.KEY_STORE_FILE_BASE64 }}" | base64 --decode > android/app/release-key.jks
          
          # Export path and alias as environment variables for build.gradle
          echo "KEY_STORE_PATH=android/app/release-key.jks" >> $GITHUB_ENV
          echo "KEY_ALIAS=upload" >> $GITHUB_ENV # Ensure 'upload' matches your key alias
        shell: bash

      # --- BUILD ---

      - name: 7. üßπ Clean Build Environment
        run: flutter clean

      - name: 8. üèóÔ∏è Build Android Release APK
        # Pass passwords from GitHub Secrets as environment variables
        env:
          KEY_STORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
          KEY_ALIAS_PASSWORD: ${{ secrets.KEY_ALIAS_PASSWORD }}
        run: flutter build apk --release --no-tree-shake-icons

      # --- UPLOAD ---

      - name: 9. üíæ Upload Release APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ethio_shop-release-apk
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 7 # Store the artifact for 7 days          cache: 'gradle'        # Enable Gradle dependency caching
                
      # --- END FIREBASE DEPLOYMENT SETUP ---
      - name: Generate Dummy Debug Keystore
        run: | 
         mkdir -p android/app
          keytool -genkey -v -keystore android/app/debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
        shell: bash
        
      - name: üîé Analyze & Test
        run: |
          flutter analyze
          flutter test
        
      - name: üèóÔ∏è Build Android App Bundle (AAB)
        # The build process now uses the decoded google-services.json
        run: flutter build appbundle --release
        
      # --- START DEPLOYMENT TO FIREBASE APP DISTRIBUTION ---

      - name: ‚öôÔ∏è Install Firebase CLI
        run: npm install -g firebase-tools
        
      - name: ‚¨ÜÔ∏è Deploy to Firebase App Distribution
        run: |
          # Finds the generated AAB file path
          AAB_FILE=$(find build/app/outputs/bundle/release/ -name "*.aab" | head -n 1)
          
          # Distribute the file
          firebase appdistribution:distribute "$AAB_FILE" \
            --app 1:672418288153:android:f6f631486c9748a883d088 \
            --release-notes "CI Build ${{ github.sha }}" \
            --groups "testers" \
            --token ${{ secrets.FIREBASE_TOKEN }}
        env:
          # Sets environment variable for Firebase CLI
          FIREBASE_CLI_EXPERIMENTAL: true
          
      # --- END DEPLOYMENT TO FIREBASE APP DISTRIBUTION ---
      
      - name: ‚úÖ Final Status
        run: echo "Build, Test, and Deployment to Firebase completed successfully."
